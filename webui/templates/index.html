<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniGate - 全能网关管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-running { color: #198754; }
        .status-stopped { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        .card { margin-bottom: 1rem; }
        .system-stats { font-size: 0.9rem; }
        .config-value { font-family: 'Courier New', monospace; background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .brand-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gate-icon { color: #667eea; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark brand-gradient">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-door-open me-2 gate-icon"></i> 
                <strong>OmniGate</strong>
                <small class="ms-2 opacity-75">全能网络网关</small>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/about" title="关于 OmniGate">
                    <i class="fas fa-info-circle"></i>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 欢迎横幅 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-4">
                        <h1 class="display-6 text-primary">
                            <i class="fas fa-door-open me-2"></i>OmniGate
                        </h1>
                        <p class="lead mb-0">全能网络网关 - 一站式网络服务解决方案</p>
                        <small class="text-muted">Omnipotent Network Gateway - All-in-One Network Services</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统状态 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-heartbeat"></i> 系统状态
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center system-stats" id="systemStats">
                            <!-- 系统信息将通过 JavaScript 动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 服务管理 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs"></i> 服务管理
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshAll()">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>服务名称</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                        <th>日志</th>
                                    </tr>
                                </thead>
                                <tbody id="servicesTable">
                                    <!-- 服务状态将通过 JavaScript 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置信息 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle"></i> 配置信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="configInfo">
                            <!-- 配置信息将通过 JavaScript 动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速下载 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-download"></i> 配置文件下载
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <a href="/download/wireguard" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-shield-alt"></i> WireGuard 配置
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/download/openvpn" class="btn btn-outline-success w-100">
                                    <i class="fas fa-lock"></i> OpenVPN 配置
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/download/frp-client" class="btn btn-outline-info w-100">
                                    <i class="fas fa-network-wired"></i> FRP 客户端配置
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/download/rustdesk-info" class="btn btn-outline-warning w-100">
                                    <i class="fas fa-desktop"></i> RustDesk 连接信息
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0">
                <i class="fas fa-door-open me-1"></i>
                <strong>OmniGate</strong> - Omnipotent Network Gateway 
                <span class="mx-2">?</span>
                v1.0.0
            </p>
            <small class="text-muted">一站式网络服务解决方案 | All-in-One Network Services</small>
        </div>
    </footer>

    <!-- 日志模态框 -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalTitle">服务日志</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="logContent" style="max-height: 60vh; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 加载服务状态
        function loadServices() {
            fetch('/api/services')
                .then(response => response.json())
                .then(services => {
                    const servicesTable = document.getElementById('servicesTable');
                    servicesTable.innerHTML = '';
                    
                    for (const [name, status] of Object.entries(services)) {
                        const statusClass = status.includes('RUNNING') ? 'status-running' : 
                                          status.includes('STOPPED') ? 'status-stopped' : 'status-unknown';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>${getServiceDisplayName(name)}</strong>
                            </td>
                            <td>
                                <span class="${statusClass}">
                                    <i class="fas ${status.includes('RUNNING') ? 'fa-play-circle' : 'fa-stop-circle'}"></i>
                                    ${status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning" onclick="restartService('${name}')">
                                    <i class="fas fa-redo"></i> 重启
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="showLogs('${name}')">
                                    <i class="fas fa-file-alt"></i> 查看日志
                                </button>
                            </td>
                        `;
                        servicesTable.appendChild(row);
                    }
                });
        }

        // 加载系统信息
        function loadSystemInfo() {
            fetch('/api/system')
                .then(response => response.json())
                .then(systemInfo => {
                    const systemStats = document.getElementById('systemStats');
                    systemStats.innerHTML = `
                        <div class="col-md-2">
                            <div class="text-primary">
                                <i class="fas fa-microchip fa-2x"></i>
                                <div>CPU</div>
                                <strong>${systemInfo.cpu_percent}%</strong>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-success">
                                <i class="fas fa-memory fa-2x"></i>
                                <div>内存</div>
                                <strong>${systemInfo.memory_percent}%</strong>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-warning">
                                <i class="fas fa-hdd fa-2x"></i>
                                <div>磁盘</div>
                                <strong>${systemInfo.disk_percent}%</strong>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-info">
                                <i class="fas fa-upload fa-2x"></i>
                                <div>上行流量</div>
                                <strong>${systemInfo.bytes_sent} MB</strong>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-info">
                                <i class="fas fa-download fa-2x"></i>
                                <div>下行流量</div>
                                <strong>${systemInfo.bytes_recv} MB</strong>
                            </div>
                        </div>
                    `;
                });
        }

        // 加载配置信息
        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    const configInfo = document.getElementById('configInfo');
                    configInfo.innerHTML = '';
                    
                    const configItems = [
                        { key: '域名', value: config.domain },
                        { key: 'Xray Reality 公钥', value: config.xray_public_key },
                        { key: 'WireGuard 公钥', value: config.wireguard_public_key },
                        { key: 'WireGuard 管理', value: `http://${config.domain}:${config.wireguard_admin_port}` },
                        { key: 'FRP 管理', value: `http://${config.domain}:${config.frp_admin_port}` }
                    ];
                    
                    configItems.forEach(item => {
                        const col = document.createElement('div');
                        col.className = 'col-md-6 mb-2';
                        col.innerHTML = `
                            <strong>${item.key}:</strong>
                            <div class="config-value">${item.value}</div>
                        `;
                        configInfo.appendChild(col);
                    });
                });
        }

        // 获取服务显示名称
        function getServiceDisplayName(name) {
            const names = {
                'xray': 'Xray Reality',
                'wireguard': 'WireGuard VPN',
                'openvpn': 'OpenVPN',
                'frp': 'FRP 内网穿透',
                'rustdesk': 'RustDesk 远程桌面',
                'webui': 'OmniGate Web 管理'
            };
            return names[name] || name;
        }

        // 重启服务
        function restartService(serviceName) {
            if (!confirm(`确定要重启 ${getServiceDisplayName(serviceName)} 服务吗？`)) {
                return;
            }
            
            fetch(`/api/restart/${serviceName}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadServices(); // 重新加载状态
                })
                .catch(error => {
                    alert('重启服务失败: ' + error);
                });
        }

        // 显示日志
        function showLogs(serviceName) {
            fetch(`/api/logs/${serviceName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('logModalTitle').textContent = `${getServiceDisplayName(serviceName)} 日志`;
                        document.getElementById('logContent').textContent = data.logs;
                        new bootstrap.Modal(document.getElementById('logModal')).show();
                    } else {
                        alert('获取日志失败: ' + data.message);
                    }
                });
        }

        // 刷新所有信息
        function refreshAll() {
            loadServices();
            loadSystemInfo();
            loadConfig();
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            refreshAll();
            
            // 每 30 秒刷新一次状态
            setInterval(() => {
                loadServices();
                loadSystemInfo();
            }, 30000);
            
            // 每 60 秒刷新一次配置
            setInterval(loadConfig, 60000);
        });
    </script>
</body>
</html>